version: '3'

vars:
  DB_HOST: localhost
  DB_PORT: 5432
  DB_USER: postgres
  DB_PASSWORD: p@ssw0rd
  DB_NAME: tut_bus
  DB_URL: 'postgres://{{.DB_USER}}:{{.DB_PASSWORD}}@{{.DB_HOST}}:{{.DB_PORT}}/{{.DB_NAME}}?sslmode=disable'
  MIGRATIONS_DIR: db/migrations
  QUERIES_DIR: db/queries
  SEEDS_COMMON_DIR: db/seeds/common
  SEEDS_PROD_DIR: db/seeds/production
  SEEDS_DEV_DIR: db/seeds/development

tasks:
  run:
    desc: 'API„Çµ„Éº„Éê„Éº„ÇíËµ∑Âãï'
    cmd: go run ./cmd/server/main.go

  build:
    desc: 'API„Çí„Éì„É´„Éâ'
    cmd: go build -o bin/server ./cmd/server/main.go

  test:
    desc: '„ÉÜ„Çπ„Éà„ÇíÂÆüË°å'
    cmd: go test -v ./...

  mod:tidy:
    desc: 'go.mod„ÇíÊï¥ÁêÜ'
    cmd: go mod tidy

  mod:download:
    desc: '‰æùÂ≠ò„Éë„ÉÉ„Ç±„Éº„Ç∏„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ'
    cmd: go mod download

  vet:
    desc: 'go vet„ÇíÂÆüË°å'
    cmd: go vet ./...

  fmt:
    desc: '„Ç≥„Éº„Éâ„Çí„Éï„Ç©„Éº„Éû„ÉÉ„Éà'
    cmd: go fmt ./...

  lint:
    desc: 'golangci-lint„ÇíÂÆüË°å'
    cmd: golangci-lint run ./...

  migrate:create:
    desc: 'Êñ∞„Åó„ÅÑ„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê (usage: task migrate:create -- create_users_table)'
    cmd: migrate create -ext sql -dir {{.MIGRATIONS_DIR}} -seq {{.CLI_ARGS}}

  migrate:up:
    desc: '„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„ÇíÈÅ©Áî®'
    cmd: migrate -path {{.MIGRATIONS_DIR}} -database "{{.DB_URL}}" up

  migrate:down:
    desc: '„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„Çí1„Å§„É≠„Éº„É´„Éê„ÉÉ„ÇØ'
    cmd: migrate -path {{.MIGRATIONS_DIR}} -database "{{.DB_URL}}" down 1

  migrate:down:all:
    desc: 'ÂÖ®„Å¶„ÅÆ„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„Çí„É≠„Éº„É´„Éê„ÉÉ„ÇØ'
    cmd: migrate -path {{.MIGRATIONS_DIR}} -database "{{.DB_URL}}" down -all

  migrate:force:
    desc: '„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„Éê„Éº„Ç∏„Éß„É≥„ÇíÂº∑Âà∂Ë®≠ÂÆö (usage: task migrate:force -- 1)'
    cmd: migrate -path {{.MIGRATIONS_DIR}} -database "{{.DB_URL}}" force {{.CLI_ARGS}}

  migrate:version:
    desc: 'ÁèæÂú®„ÅÆ„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„Éê„Éº„Ç∏„Éß„É≥„ÇíË°®Á§∫'
    cmd: migrate -path {{.MIGRATIONS_DIR}} -database "{{.DB_URL}}" version

  migrate:goto:
    desc: 'ÁâπÂÆö„ÅÆ„Éê„Éº„Ç∏„Éß„É≥„Å´„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥ (usage: task migrate:goto -- 2)'
    cmd: migrate -path {{.MIGRATIONS_DIR}} -database "{{.DB_URL}}" goto {{.CLI_ARGS}}

  sqlc:generate:
    desc: 'sqlc„ÅßGo„Ç≥„Éº„Éâ„ÇíÁîüÊàê'
    cmd: sqlc generate

  sqlc:compile:
    desc: 'sqlc„ÇØ„Ç®„É™„ÅÆÊßãÊñá„ÉÅ„Çß„ÉÉ„ÇØ'
    cmd: sqlc compile

  sqlc:verify:
    desc: 'sqlcÁîüÊàê„Ç≥„Éº„Éâ„ÅÆÊ§úË®º'
    cmd: sqlc verify

  sqlc:vet:
    desc: 'sqlc„ÇØ„Ç®„É™„ÅÆÈùôÁöÑËß£Êûê'
    cmd: sqlc vet

  db:shell:
    desc: 'PostgreSQL„Ç∑„Çß„É´„Å´Êé•Á∂ö'
    cmd: PGPASSWORD={{.DB_PASSWORD}} psql -h {{.DB_HOST}} -p {{.DB_PORT}} -U {{.DB_USER}} -d {{.DB_NAME}}

  db:reset:
    desc: '„Éá„Éº„Çø„Éô„Éº„Çπ„Çí„É™„Çª„ÉÉ„Éà(ÂÖ®„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥down‚Üíup)'
    cmds:
      - task: migrate:down:all
      - task: migrate:up

  db:reset:seed:
    desc: '„Éá„Éº„Çø„Éô„Éº„Çπ„Çí„É™„Çª„ÉÉ„Éà„Åó„Å¶„Ç∑„Éº„Éâ„Éá„Éº„Çø„ÇÇÊäïÂÖ•'
    cmds:
      - task: db:reset
      - task: db:seed:all

  db:seed:common:
    desc: 'ÂÖ±ÈÄö„Ç∑„Éº„Éâ„Éá„Éº„Çø„ÇíÊäïÂÖ•ÔºàÂÖ®Áí∞Â¢ÉÂÖ±ÈÄöÔºâ'
    cmds:
      - |
        echo "üå± ÂÖ±ÈÄö„Ç∑„Éº„Éâ„Éá„Éº„Çø„ÇíÈÅ©Áî®‰∏≠..."
        for f in $(ls db/seeds/common/*.sql 2>/dev/null | sort); do
          echo "  ÈÅ©Áî®‰∏≠: $(basename $f)"
          PGPASSWORD={{.DB_PASSWORD}} psql -h {{.DB_HOST}} -p {{.DB_PORT}} -U {{.DB_USER}} -d {{.DB_NAME}} -f "$f"
        done
        echo "‚úÖ ÂÖ±ÈÄö„Ç∑„Éº„Éâ„Éá„Éº„ÇøÈÅ©Áî®ÂÆå‰∫Ü"

  db:seed:prod:
    desc: 'Êú¨Áï™Áî®„Ç∑„Éº„Éâ„Éá„Éº„Çø„ÇíÊäïÂÖ•'
    cmds:
      - |
        echo "üå± Êú¨Áï™„Ç∑„Éº„Éâ„Éá„Éº„Çø„ÇíÈÅ©Áî®‰∏≠..."
        for f in $(ls db/seeds/production/*.sql 2>/dev/null | sort); do
          echo "  ÈÅ©Áî®‰∏≠: $(basename $f)"
          PGPASSWORD={{.DB_PASSWORD}} psql -h {{.DB_HOST}} -p {{.DB_PORT}} -U {{.DB_USER}} -d {{.DB_NAME}} -f "$f"
        done
        echo "‚úÖ Êú¨Áï™„Ç∑„Éº„Éâ„Éá„Éº„ÇøÈÅ©Áî®ÂÆå‰∫Ü"

  db:seed:dev:
    desc: 'ÈñãÁô∫Áî®„Ç∑„Éº„Éâ„Éá„Éº„Çø„ÇíÊäïÂÖ•'
    cmds:
      - |
        echo "üå± ÈñãÁô∫„Ç∑„Éº„Éâ„Éá„Éº„Çø„ÇíÈÅ©Áî®‰∏≠..."
        for f in $(ls db/seeds/development/*.sql 2>/dev/null | sort); do
          echo "  ÈÅ©Áî®‰∏≠: $(basename $f)"
          PGPASSWORD={{.DB_PASSWORD}} psql -h {{.DB_HOST}} -p {{.DB_PORT}} -U {{.DB_USER}} -d {{.DB_NAME}} -f "$f"
        done
        echo "‚úÖ ÈñãÁô∫„Ç∑„Éº„Éâ„Éá„Éº„ÇøÈÅ©Áî®ÂÆå‰∫Ü"

  db:seed:all:
    desc: 'ÂÖ®„Ç∑„Éº„Éâ„Éá„Éº„Çø„ÇíÊäïÂÖ•ÔºàÂÖ±ÈÄö ‚Üí Êú¨Áï™ ‚Üí ÈñãÁô∫Ôºâ'
    cmds:
      - task: db:seed:common
      - task: db:seed:prod
      - task: db:seed:dev

  db:seed:
    desc: '„Ç∑„Éº„Éâ„Éá„Éº„Çø„ÇíÊäïÂÖ•Ôºàdb:seed:all„ÅÆ„Ç®„Ç§„É™„Ç¢„ÇπÔºâ'
    cmds:
      - task: db:seed:all

  db:dump:
    desc: '„Éá„Éº„Çø„Éô„Éº„Çπ„Çí„ÉÄ„É≥„Éó'
    cmd: PGPASSWORD={{.DB_PASSWORD}} pg_dump -h {{.DB_HOST}} -p {{.DB_PORT}} -U {{.DB_USER}} {{.DB_NAME}} > dump_{{.TIMESTAMP}}.sql
    vars:
      TIMESTAMP:
        sh: date +%Y%m%d_%H%M%S

  db:restore:
    desc: '„ÉÄ„É≥„Éó„Åã„Çâ„É™„Çπ„Éà„Ç¢ (usage: task db:restore -- dump_20241016_123456.sql)'
    cmd: PGPASSWORD={{.DB_PASSWORD}} psql -h {{.DB_HOST}} -p {{.DB_PORT}} -U {{.DB_USER}} -d {{.DB_NAME}} < {{.CLI_ARGS}}

  setup:
    desc: 'ÈñãÁô∫Áí∞Â¢É„Çí„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó'
    cmds:
      - task: mod:download
      - task: migrate:up
      - task: sqlc:generate
      - echo "‚úÖ „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü!"

  gen:
    desc: '„Ç≥„Éº„ÉâÁîüÊàê(sqlc)'
    cmd: task sqlc:generate

  docker:shell:
    desc: 'API„Ç≥„É≥„ÉÜ„Éä„Å´„Ç∑„Çß„É´Êé•Á∂ö'
    cmd: docker exec -it api sh

  docker:logs:
    desc: 'API„Ç≥„É≥„ÉÜ„Éä„ÅÆ„É≠„Ç∞„ÇíË°®Á§∫'
    cmd: docker logs -f api

  generate:service:
    desc: 'PDF„Åã„Çâ„Çµ„Éº„Éì„ÇπJSON„ÇíÁîüÊàê (usage: task generate:service -- --pdf path/to/timetable.pdf)'
    dir: tools/service-generator
    cmd: go run main.go {{.CLI_ARGS}}

  generate:service:setup:
    desc: '„Çµ„Éº„Éì„Çπ„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº„ÅÆ‰æùÂ≠ò„Éë„ÉÉ„Ç±„Éº„Ç∏„Çí„Ç§„É≥„Çπ„Éà„Éº„É´'
    dir: tools/service-generator
    cmd: go mod tidy

  default:
    desc: 'Âà©Áî®ÂèØËÉΩ„Å™„Çø„Çπ„ÇØ‰∏ÄË¶ß„ÇíË°®Á§∫'
    cmds:
      - task --list
    silent: true
