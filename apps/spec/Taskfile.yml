version: '3'

vars:
  OPENAPI_FILE: dist/openapi.yaml
  TS_OUTPUT: ../web/generated/oas.d.ts
  GO_OUTPUT_DIR: ../api/pkg/oapi

tasks:
  compile:
    desc: "TypeSpecä»•æ§˜ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«"
    cmd: pnpm gen:spec

  lint:
    desc: "TypeSpecã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯"
    cmd: pnpm lint

  fix:
    desc: "TypeSpecã‚’è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
    cmd: pnpm fix

  gen:spec:
    desc: "OpenAPIä»•æ§˜ã‚’ç”Ÿæˆ"
    cmd: pnpm gen:spec

  gen:ts:
    desc: "TypeScriptã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ç”Ÿæˆ"
    cmd: pnpm gen:ts

  gen:go:
    desc: "Goã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ"
    cmd: pnpm gen:go

  gen:all:
    desc: "ã™ã¹ã¦ã®ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ(specâ†’tsâ†’go)"
    cmds:
      - task: gen:spec
      - task: gen:ts
      - task: gen:go

  clean:ts:
    desc: "TypeScriptç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤"
    cmd: pnpm clean:ts

  clean:go:
    desc: "Goç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤"
    cmd: pnpm clean:go

  clean:all:
    desc: "ã™ã¹ã¦ã®ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤"
    cmds:
      - task: clean:ts
      - task: clean:go
      - rm -rf dist
      - echo "âœ… ã™ã¹ã¦ã®ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"

  validate:
    desc: "OpenAPIä»•æ§˜ã‚’æ¤œè¨¼"
    cmd: |
      if [ -f "{{.OPENAPI_FILE}}" ]; then
        echo "âœ… OpenAPIä»•æ§˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™"
        echo "ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«: {{.OPENAPI_FILE}}"
      else
        echo "âŒ OpenAPIä»•æ§˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        exit 1
      fi

  check:outputs:
    desc: "ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª"
    cmds:
      - echo "=== TypeScriptå‡ºåŠ› ==="
      - ls -lh {{.TS_OUTPUT}} 2>/dev/null || echo "âŒ TypeScriptãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
      - echo ""
      - echo "=== Goå‡ºåŠ› ==="
      - ls -lh {{.GO_OUTPUT_DIR}}/ 2>/dev/null || echo "âŒ Goãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

  install:
    desc: "ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
    cmd: pnpm install

  update:
    desc: "ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ"
    cmd: pnpm update

  rebuild:
    desc: "ã‚¯ãƒªãƒ¼ãƒ³â†’ã™ã¹ã¦å†ç”Ÿæˆ"
    cmds:
      - task: clean:all
      - task: gen:all
      - echo "âœ… å†ç”Ÿæˆå®Œäº†!"

  docs:
    desc: "OpenAPIä»•æ§˜ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§è¡¨ç¤º"
    cmd: |
      if command -v open > /dev/null; then
        open {{.OPENAPI_FILE}}
      elif command -v xdg-open > /dev/null; then
        xdg-open {{.OPENAPI_FILE}}
      else
        echo "ãƒ•ã‚¡ã‚¤ãƒ«: {{.OPENAPI_FILE}}"
      fi

  default:
    desc: "åˆ©ç”¨å¯èƒ½ãªã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’è¡¨ç¤º"
    cmds:
      - task --list
    silent: true
