# ========================================
# Migration Deploy - Production (Cloud Run Job)
# ========================================
# Cloud Run Job ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPã®Cloud SQLã«
# ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ã™ã‚‹ã€‚
#
# ä»•çµ„ã¿:
#   1. ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ â†’ Artifact Registryã«push
#   2. Cloud Run Job ã‚’ä½œæˆï¼ˆ--add-cloudsql-instances ã§ãƒ—ãƒ­ã‚­ã‚·å†…è”µï¼‰
#   3. Job ã‚’å®Ÿè¡Œã—ã€å®Œäº†ã‚’å¾…æ©Ÿ
#   4. Job ã‚’å‰Šé™¤ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰
#
# Cloud SQLã¸ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPå…¬é–‹ã¯ä¸è¦ã§ã™ã€‚
# IAMèªè¨¼ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç®¡ç†ã‚‚ä¸è¦ã§ã™ã€‚
#
# å¿…è¦ãªGitHubè¨­å®š:
#   Vars: WIF_PROVIDER, TERRAFORM_SA, GCP_PROJECT_ID

name: 'Migration Deploy'

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'å®Ÿè¡Œã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³'
        required: true
        type: choice
        options:
          - 'up'
          - 'up-1'
          - 'down-1'
          - 'version'
          - 'seed'
        default: 'version'
      confirm:
        description: 'æœ¬ç•ªDBã«é©ç”¨ã—ã¾ã™ã€‚å®Ÿè¡Œã™ã‚‹å ´åˆã¯ "yes" ã¨å…¥åŠ›'
        required: true
        type: string

permissions:
  contents: read
  id-token: write

env:
  REGION: asia-northeast1
  AR_REGISTRY: asia-northeast1-docker.pkg.dev
  AR_REPO: tut-bus
  IMAGE_NAME: migration
  DB_INSTANCE: 'main-vcompute:asia-northeast1:tut-bus-db-prod'
  DB_NAME: 'tutbus'
  # IAMèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆSAåã‹ã‚‰ .gserviceaccount.com ã‚’é™¤ã„ãŸã‚‚ã®ï¼‰
  DB_USER: 'tut-bus-app-sa@main-vcompute.iam'
  # App SAï¼ˆCloud SQLã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ + IAMèªè¨¼æ¨©é™ã‚’æŒã¤ï¼‰
  APP_SA: 'tut-bus-app-sa@main-vcompute.iam.gserviceaccount.com'

jobs:
  migrate:
    name: 'Run Migration (${{ inputs.action }})'
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Confirm Input
        if: inputs.action != 'version' && inputs.confirm != 'yes'
        run: |
          echo "::error::ç¢ºèªå…¥åŠ›ãŒ 'yes' ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å‡¦ç†ã‚’ä¸­æ­¢ã—ã¾ã™ã€‚"
          exit 1

      - name: Checkout
        uses: actions/checkout@v6

      - name: Google Cloud Auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ vars.WIF_PROVIDER }}
          service_account: ${{ vars.TERRAFORM_SA }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v3
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.AR_REGISTRY }} --quiet

      - name: Build Migration Image
        working-directory: apps/api
        run: |
          IMAGE="${{ env.AR_REGISTRY }}/${{ vars.GCP_PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_NAME }}:gh-${{ github.run_number }}"
          echo "IMAGE=${IMAGE}" >> "$GITHUB_ENV"

          docker build \
            -f migration.Dockerfile \
            -t "${IMAGE}" \
            .

          echo "âœ… ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰å®Œäº†: ${IMAGE}"

      - name: Push Migration Image
        run: |
          docker push "${IMAGE}"
          echo "âœ… ã‚¤ãƒ¡ãƒ¼ã‚¸pushå®Œäº†"

      - name: Create Cloud Run Job
        run: |
          JOB_NAME="tut-bus-migration-${{ github.run_number }}"
          echo "JOB_NAME=${JOB_NAME}" >> "$GITHUB_ENV"

          gcloud run jobs create "${JOB_NAME}" \
            --image="${IMAGE}" \
            --region="${{ env.REGION }}" \
            --project="${{ vars.GCP_PROJECT_ID }}" \
            --set-cloudsql-instances="${{ env.DB_INSTANCE }}" \
            --service-account="${{ env.APP_SA }}" \
            --set-env-vars="MIGRATE_ACTION=${{ inputs.action }},DB_USER=${{ env.DB_USER }},DB_NAME=${{ env.DB_NAME }},INSTANCE_CONNECTION_NAME=${{ env.DB_INSTANCE }},USE_IAM_AUTH=true" \
            --max-retries=0 \
            --task-timeout=300s \
            --memory=512Mi \
            --cpu=1 \
            --quiet

          echo "âœ… Cloud Run Job '${JOB_NAME}' ä½œæˆå®Œäº†"

      - name: Execute Cloud Run Job
        run: |
          echo "ðŸš€ Cloud Run Job ã‚’å®Ÿè¡Œä¸­..."
          gcloud run jobs execute "${JOB_NAME}" \
            --region="${{ env.REGION }}" \
            --project="${{ vars.GCP_PROJECT_ID }}" \
            --wait \
            --quiet

          echo "âœ… Cloud Run Job å®Ÿè¡Œå®Œäº†"

      - name: Show Job Logs
        if: always()
        run: |
          echo "ðŸ“‹ Cloud Run Job ãƒ­ã‚°:"
          gcloud logging read \
            "resource.type=cloud_run_job AND resource.labels.job_name=${JOB_NAME}" \
            --project="${{ vars.GCP_PROJECT_ID }}" \
            --limit=50 \
            --format="table(timestamp, textPayload)" \
            --freshness=10m \
            2>/dev/null || echo "(ãƒ­ã‚°å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ)"

      - name: Cleanup Cloud Run Job
        if: always()
        run: |
          echo "ðŸ§¹ Cloud Run Job ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
          gcloud run jobs delete "${JOB_NAME}" \
            --region="${{ env.REGION }}" \
            --project="${{ vars.GCP_PROJECT_ID }}" \
            --quiet \
            2>/dev/null || echo "  (ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¹ã‚­ãƒƒãƒ—)"
          echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"

      - name: Cleanup Old Migration Images
        if: always()
        run: |
          echo "ðŸ§¹ å¤ã„ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
          # æœ€æ–°5ã¤ä»¥å¤–ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°ã‚’å‰Šé™¤
          OLD_TAGS=$(gcloud artifacts docker tags list \
            "${{ env.AR_REGISTRY }}/${{ vars.GCP_PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_NAME }}" \
            --format='value(tag)' \
            --sort-by='~tag' \
            2>/dev/null | tail -n +6)

          if [ -n "$OLD_TAGS" ]; then
            for tag in $OLD_TAGS; do
              gcloud artifacts docker images delete \
                "${{ env.AR_REGISTRY }}/${{ vars.GCP_PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_NAME }}:${tag}" \
                --quiet --delete-tags 2>/dev/null || true
            done
          fi
          echo "âœ… ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"

      - name: Migration Summary
        if: always()
        run: |
          echo "### Migration Deploy Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Item | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Action | \`${{ inputs.action }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Instance | \`${{ env.DB_INSTANCE }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Database | \`${{ env.DB_NAME }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Image | \`${IMAGE}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Cloud Run Job | \`${JOB_NAME}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Trigger | @${{ github.actor }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Status | \`${{ job.status }}\` |" >> "$GITHUB_STEP_SUMMARY"
