# ========================================
# Migration CI - Validate & Test
# ========================================
# PRæ™‚ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼ã¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
# - ãƒ•ã‚¡ã‚¤ãƒ«å‘½åè¦å‰‡ãƒã‚§ãƒƒã‚¯
# - up/downãƒšã‚¢å­˜åœ¨ãƒã‚§ãƒƒã‚¯
# - PostgreSQL 15ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œãƒ†ã‚¹ãƒˆ
# - sqlcã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ¤œè¨¼

name: 'Migration CI'

on:
  pull_request:
    branches: [main, dev]
    paths:
      - 'apps/api/db/migrations/**'
      - 'apps/api/db/queries/**'
      - 'apps/api/db/seeds/**'
      - 'apps/api/sqlc.yaml'
  push:
    branches: [main, dev]
    paths:
      - 'apps/api/db/migrations/**'
      - 'apps/api/db/queries/**'
      - 'apps/api/db/seeds/**'
      - 'apps/api/sqlc.yaml'

permissions:
  contents: read
  pull-requests: write

defaults:
  run:
    working-directory: apps/api

env:
  MIGRATE_VERSION: 'v4.18.3'
  SQLC_VERSION: '1.28.0'

jobs:
  validate:
    name: 'Validate Migration Files'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check Migration File Naming
        run: |
          echo "ğŸ” ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®å‘½åè¦å‰‡ã‚’ãƒã‚§ãƒƒã‚¯..."
          ERRORS=0

          for file in db/migrations/*.sql; do
            [ -e "$file" ] || continue
            basename=$(basename "$file")

            # å‘½åè¦å‰‡: NNNNNN_<description>.(up|down).sql
            if ! echo "$basename" | grep -qE '^[0-9]{6}_[a-z_]+\.(up|down)\.sql$'; then
              echo "::error file=$file::å‘½åè¦å‰‡é•å: $basename (æœŸå¾…: NNNNNN_description.up.sql / NNNNNN_description.down.sql)"
              ERRORS=$((ERRORS + 1))
            fi
          done

          if [ "$ERRORS" -gt 0 ]; then
            exit 1
          fi
          echo "âœ… å‘½åè¦å‰‡ãƒã‚§ãƒƒã‚¯ OK"

      - name: Check Up/Down Pairs
        run: |
          echo "ğŸ” up/downãƒšã‚¢ã®å­˜åœ¨ã‚’ãƒã‚§ãƒƒã‚¯..."
          ERRORS=0

          # up ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾å¿œã™ã‚‹ down ãŒã‚ã‚‹ã‹
          for up_file in db/migrations/*.up.sql; do
            [ -e "$up_file" ] || continue
            down_file="${up_file%.up.sql}.down.sql"
            if [ ! -f "$down_file" ]; then
              echo "::error file=$up_file::å¯¾å¿œã™ã‚‹downãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“: $(basename "$down_file")"
              ERRORS=$((ERRORS + 1))
            fi
          done

          # down ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾å¿œã™ã‚‹ up ãŒã‚ã‚‹ã‹
          for down_file in db/migrations/*.down.sql; do
            [ -e "$down_file" ] || continue
            up_file="${down_file%.down.sql}.up.sql"
            if [ ! -f "$up_file" ]; then
              echo "::error file=$down_file::å¯¾å¿œã™ã‚‹upãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“: $(basename "$up_file")"
              ERRORS=$((ERRORS + 1))
            fi
          done

          if [ "$ERRORS" -gt 0 ]; then
            exit 1
          fi
          echo "âœ… up/downãƒšã‚¢ãƒã‚§ãƒƒã‚¯ OK"

      - name: Check Migration Sequence
        run: |
          echo "ğŸ” ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç•ªå·ã®é€£ç¶šæ€§ã‚’ãƒã‚§ãƒƒã‚¯..."

          # up ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç•ªå·ã‚’æŠ½å‡ºã—ã¦ã‚½ãƒ¼ãƒˆ
          NUMBERS=$(ls db/migrations/*.up.sql 2>/dev/null | xargs -I{} basename {} | grep -oE '^[0-9]+' | sort -n | uniq)

          PREV=0
          for NUM in $NUMBERS; do
            # å…ˆé ­ã®0ã‚’é™¤å»ã—ã¦æ•°å€¤æ¯”è¼ƒ
            CLEAN_NUM=$((10#$NUM))
            EXPECTED=$((PREV + 1))
            if [ "$CLEAN_NUM" -ne "$EXPECTED" ]; then
              echo "::warning::ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç•ªå·ãŒé€£ç¶šã—ã¦ã„ã¾ã›ã‚“: $PREV â†’ $CLEAN_NUM (æœŸå¾…: $EXPECTED)"
            fi
            PREV=$CLEAN_NUM
          done

          echo "âœ… ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯å®Œäº†"

      # -----------------------------------------------
      # Seed Safety Check (seedlint)
      # PostgreSQL AST ãƒ‘ãƒ¼ã‚µãƒ¼ã«ã‚ˆã‚‹SQLå®‰å…¨æ€§æ¤œè¨¼
      # æ­£è¦è¡¨ç¾ã§ã¯ãªãpg_queryã§æ§‹æ–‡æœ¨ã‚’è§£æã™ã‚‹ãŸã‚èª¤æ¤œçŸ¥ãªã—
      # -----------------------------------------------
      - name: Setup Go (for seedlint)
        uses: actions/setup-go@v6
        with:
          go-version-file: apps/api/go.mod
          cache-dependency-path: apps/api/tools/seedlint/go.sum

      - name: Build seedlint
        run: |
          cd tools/seedlint
          go build -o seedlint .
          echo "âœ… seedlint ãƒ“ãƒ«ãƒ‰å®Œäº†"

      - name: Check Seed Safety (common/ + production/)
        run: |
          echo "ğŸ” common/ + production/ ã‚·ãƒ¼ãƒ‰ã®å®‰å…¨æ€§ã‚’ãƒã‚§ãƒƒã‚¯ (seedlint safe)..."
          tools/seedlint/seedlint safe db/seeds/common/ db/seeds/production/

      - name: Check Seed Syntax (development/)
        run: |
          echo "ğŸ” development/ ã‚·ãƒ¼ãƒ‰ã®æ§‹æ–‡ã‚’ãƒã‚§ãƒƒã‚¯ (seedlint syntax)..."
          tools/seedlint/seedlint syntax db/seeds/development/

  test:
    name: 'Test Migrations'
    runs-on: ubuntu-latest
    needs: validate

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: tut_bus_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -h localhost -U postgres"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=10
          --health-start-period=5s

    env:
      DB_URL: 'postgres://postgres:testpassword@localhost:5432/tut_bus_test?sslmode=disable'

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: apps/api/go.mod
          cache-dependency-path: apps/api/go.sum

      - name: Install golang-migrate
        run: |
          curl -fsSL "https://github.com/golang-migrate/migrate/releases/download/${{ env.MIGRATE_VERSION }}/migrate.linux-amd64.tar.gz" | tar xz
          sudo mv migrate /usr/local/bin/migrate
          migrate --version

      - name: Install sqlc
        run: |
          curl -fsSL "https://github.com/sqlc-dev/sqlc/releases/download/v${{ env.SQLC_VERSION }}/sqlc_${{ env.SQLC_VERSION }}_linux_amd64.tar.gz" | tar xz
          sudo mv sqlc /usr/local/bin/sqlc
          sqlc version

      - name: Run Migrations Up
        run: |
          echo "â¬†ï¸ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ä¸­..."
          migrate -path db/migrations -database "${{ env.DB_URL }}" up
          echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨å®Œäº†"

      - name: Verify Schema
        run: |
          echo "ğŸ” ã‚¹ã‚­ãƒ¼ãƒã‚’æ¤œè¨¼ä¸­..."
          PGPASSWORD=testpassword psql -h localhost -U postgres -d tut_bus_test -c "\dt" -c "\di"

      - name: sqlc Compile Check
        run: |
          echo "ğŸ” sqlcã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯..."
          sqlc compile
          echo "âœ… sqlcã‚³ãƒ³ãƒ‘ã‚¤ãƒ« OK"

      # âš ï¸ ä»¥ä¸‹ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã¯CIå°‚ç”¨ã®ãƒ†ã‚¹ãƒˆDBã‚³ãƒ³ãƒ†ãƒŠï¼ˆtut_bus_testï¼‰ã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
      # æœ¬ç•ªDBã«ã¯ä¸€åˆ‡æ¥ç¶šãƒ»å½±éŸ¿ã—ã¾ã›ã‚“ã€‚
      # down -all ã§ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼ã—ã¦ã„ã¾ã™ã€‚
      - name: Run Migrations Down (Rollback Test)
        run: |
          echo "â¬‡ï¸ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆä¸­ï¼ˆCI ãƒ†ã‚¹ãƒˆDB: tut_bus_testï¼‰..."
          migrate -path db/migrations -database "${{ env.DB_URL }}" down -all
          echo "âœ… å…¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆåŠŸ"

      - name: Run Migrations Up Again (Idempotency Test)
        run: |
          echo "â¬†ï¸ å†é©ç”¨ãƒ†ã‚¹ãƒˆä¸­..."
          migrate -path db/migrations -database "${{ env.DB_URL }}" up
          echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å†é©ç”¨æˆåŠŸ"

      - name: Test Common Seeds
        run: |
          echo "ğŸŒ± å…±é€šã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®ãƒ†ã‚¹ãƒˆ..."
          for seed_file in db/seeds/common/*.sql; do
            [ -e "$seed_file" ] || continue
            echo "  é©ç”¨ä¸­: $(basename "$seed_file")"
            PGPASSWORD=testpassword psql -h localhost -U postgres -d tut_bus_test -f "$seed_file"
          done
          echo "âœ… å…±é€šã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿é©ç”¨ãƒ†ã‚¹ãƒˆå®Œäº†"

      - name: Test Production Seeds
        run: |
          echo "ğŸŒ± æœ¬ç•ªã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®ãƒ†ã‚¹ãƒˆ..."
          for seed_file in db/seeds/production/*.sql; do
            [ -e "$seed_file" ] || continue
            echo "  é©ç”¨ä¸­: $(basename "$seed_file")"
            PGPASSWORD=testpassword psql -h localhost -U postgres -d tut_bus_test -f "$seed_file"
          done
          echo "âœ… æœ¬ç•ªã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿é©ç”¨ãƒ†ã‚¹ãƒˆå®Œäº†"

      - name: Test Seed Idempotency (common + production)
        run: |
          echo "ğŸ” ã‚·ãƒ¼ãƒ‰å†ªç­‰æ€§ãƒ†ã‚¹ãƒˆ..."
          echo "  ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã—ã¦ã‹ã‚‰seedã‚’å†å®Ÿè¡Œã—ã€å¤‰æ›´ãŒä¿æŒã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼"

          # ç¾åœ¨ã®ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ã‚’å–å¾—
          COUNT_BEFORE=$(PGPASSWORD=testpassword psql -h localhost -U postgres -d tut_bus_test \
            -t -A -c "SELECT count(*) FROM bus_stops;" 2>/dev/null || echo "0")
          echo "  seedé©ç”¨å¾Œã®ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°: $COUNT_BEFORE"

          # ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ï¼ˆç®¡ç†ç”»é¢ã§ã®æ“ä½œã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼‰
          PGPASSWORD=testpassword psql -h localhost -U postgres -d tut_bus_test -c "
            -- æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã®åå‰ã‚’å¤‰æ›´ï¼ˆç®¡ç†ç”»é¢ã§ã®ç·¨é›†ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼‰
            UPDATE bus_stops SET name = name || '_MODIFIED' WHERE id = (SELECT MIN(id) FROM bus_stops);
            -- æ–°ã—ã„ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ï¼ˆç®¡ç†ç”»é¢ã§ã®è¿½åŠ ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼‰
            INSERT INTO bus_stops (name, lat, lng) VALUES ('USER_ADDED_STOP', 0, 0);
          " 2>/dev/null || echo "  (ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ã‚¹ã‚­ãƒƒãƒ— - ãƒ†ãƒ¼ãƒ–ãƒ«ãŒç©ºã®å¯èƒ½æ€§)"

          # å¤‰æ›´å¾Œã®çŠ¶æ…‹ã‚’è¨˜éŒ²
          MODIFIED_NAME=$(PGPASSWORD=testpassword psql -h localhost -U postgres -d tut_bus_test \
            -t -A -c "SELECT name FROM bus_stops WHERE name LIKE '%_MODIFIED' LIMIT 1;" 2>/dev/null || echo "")
          USER_ADDED=$(PGPASSWORD=testpassword psql -h localhost -U postgres -d tut_bus_test \
            -t -A -c "SELECT count(*) FROM bus_stops WHERE name = 'USER_ADDED_STOP';" 2>/dev/null || echo "0")

          # seed ã‚’å†å®Ÿè¡Œ
          echo "  common seeds ã‚’å†é©ç”¨..."
          for seed_file in db/seeds/common/*.sql; do
            [ -e "$seed_file" ] || continue
            PGPASSWORD=testpassword psql -h localhost -U postgres -d tut_bus_test -f "$seed_file" 2>/dev/null
          done

          echo "  production seeds ã‚’å†é©ç”¨..."
          for seed_file in db/seeds/production/*.sql; do
            [ -e "$seed_file" ] || continue
            PGPASSWORD=testpassword psql -h localhost -U postgres -d tut_bus_test -f "$seed_file" 2>/dev/null
          done

          # æ¤œè¨¼: å¤‰æ›´ãŒä¿æŒã•ã‚Œã¦ã„ã‚‹ã‹
          ERRORS=0

          MODIFIED_NAME_AFTER=$(PGPASSWORD=testpassword psql -h localhost -U postgres -d tut_bus_test \
            -t -A -c "SELECT name FROM bus_stops WHERE name LIKE '%_MODIFIED' LIMIT 1;" 2>/dev/null || echo "")
          if [ -n "$MODIFIED_NAME" ] && [ "$MODIFIED_NAME" != "$MODIFIED_NAME_AFTER" ]; then
            echo "::error::å†ªç­‰æ€§é•å: ç·¨é›†æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã—ãŸ ($MODIFIED_NAME â†’ $MODIFIED_NAME_AFTER)"
            ERRORS=$((ERRORS + 1))
          else
            echo "  âœ… ç·¨é›†æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ãŒä¿æŒã•ã‚Œã¦ã„ã¾ã™"
          fi

          USER_ADDED_AFTER=$(PGPASSWORD=testpassword psql -h localhost -U postgres -d tut_bus_test \
            -t -A -c "SELECT count(*) FROM bus_stops WHERE name = 'USER_ADDED_STOP';" 2>/dev/null || echo "0")
          if [ "$USER_ADDED_AFTER" != "$USER_ADDED" ]; then
            echo "::error::å†ªç­‰æ€§é•å: ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ"
            ERRORS=$((ERRORS + 1))
          else
            echo "  âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ãƒ‡ãƒ¼ã‚¿ãŒä¿æŒã•ã‚Œã¦ã„ã¾ã™"
          fi

          if [ "$ERRORS" -gt 0 ]; then
            exit 1
          fi
          echo "âœ… ã‚·ãƒ¼ãƒ‰å†ªç­‰æ€§ãƒ†ã‚¹ãƒˆå®Œäº†"

      - name: Go Download Dependencies
        run: go mod download

      - name: Go Build Check
        run: CGO_ENABLED=0 go build -o /dev/null .

      - name: Go Tests
        run: go test -v -race ./...

      - name: Migration Summary
        if: always()
        run: |
          echo "### Migration CI Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Check | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|--------|" >> "$GITHUB_STEP_SUMMARY"

          MIGRATION_COUNT=$(ls db/migrations/*.up.sql 2>/dev/null | wc -l | tr -d ' ')
          SEED_COMMON_COUNT=$(ls db/seeds/common/*.sql 2>/dev/null | wc -l | tr -d ' ')
          SEED_PROD_COUNT=$(ls db/seeds/production/*.sql 2>/dev/null | wc -l | tr -d ' ')
          QUERY_COUNT=$(ls db/queries/*.sql 2>/dev/null | wc -l | tr -d ' ')

          echo "| Migration Files | ${MIGRATION_COUNT} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Common Seeds | ${SEED_COMMON_COUNT} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Production Seeds | ${SEED_PROD_COUNT} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Query Files | ${QUERY_COUNT} |" >> "$GITHUB_STEP_SUMMARY"
