version: '3'

vars:
  DOCKER_COMPOSE: docker compose

includes:
  api:
    taskfile: ./apps/api/Taskfile.yml
    dir: ./apps/api
  web:
    taskfile: ./apps/web/Taskfile.yml
    dir: ./apps/web
  spec:
    taskfile: ./apps/spec/Taskfile.yml
    dir: ./apps/spec

tasks:
  up:
    desc: 'Dockerç’°å¢ƒã‚’èµ·å‹•'
    cmd: '{{.DOCKER_COMPOSE}} up -d'

  down:
    desc: 'Dockerç’°å¢ƒã‚’åœæ­¢'
    cmd: '{{.DOCKER_COMPOSE}} down'

  restart:
    desc: 'Dockerç’°å¢ƒã‚’å†èµ·å‹•'
    cmds:
      - '{{.DOCKER_COMPOSE}} down'
      - '{{.DOCKER_COMPOSE}} up -d'

  logs:
    desc: 'Dockerç’°å¢ƒã®ãƒ­ã‚°ã‚’è¡¨ç¤º'
    cmd: '{{.DOCKER_COMPOSE}} logs -f'

  logs:web:
    desc: 'webã‚³ãƒ³ãƒ†ãƒŠã®ãƒ­ã‚°ã‚’è¡¨ç¤º'
    cmd: '{{.DOCKER_COMPOSE}} logs -f web'

  logs:api:
    desc: 'apiã‚³ãƒ³ãƒ†ãƒŠã®ãƒ­ã‚°ã‚’è¡¨ç¤º'
    cmd: '{{.DOCKER_COMPOSE}} logs -f api'

  logs:db:
    desc: 'dbã‚³ãƒ³ãƒ†ãƒŠã®ãƒ­ã‚°ã‚’è¡¨ç¤º'
    cmd: '{{.DOCKER_COMPOSE}} logs -f db'

  ps:
    desc: 'å®Ÿè¡Œä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤º'
    cmd: '{{.DOCKER_COMPOSE}} ps'

  clean:
    desc: 'Dockerç’°å¢ƒã‚’å®Œå…¨ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—(ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚‚å‰Šé™¤)'
    cmd: '{{.DOCKER_COMPOSE}} down -v'

  setup:
    desc: 'åˆå›é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'
    cmds:
      - pnpm install
      - task: up
      - sleep 5
      - task: api:migrate:up
      - echo "âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†!"

  install:
    desc: 'ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«'
    cmd: pnpm install

  gen:spec:
    desc: 'OpenAPIä»•æ§˜ã‚’ç”Ÿæˆ'
    cmd: pnpm run gen:spec

  gen:clients:
    desc: 'TypeScript/Goã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ç”Ÿæˆ'
    cmd: pnpm run gen:clients

  gen:all:
    desc: 'ã™ã¹ã¦ã®ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’å®Ÿè¡Œ'
    cmds:
      - task: gen:spec
      - task: gen:clients
      - task: api:sqlc:generate

  fmt:
    desc: 'å…¨ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’å®Ÿè¡Œ'
    cmds:
      - pnpm run fix
      - task: api:fmt
      - task: spec:fix
      - task: tf:fmt

  lint:
    desc: 'å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®Lintå®Ÿè¡Œ'
    cmd: pnpm run lint

  fix:
    desc: 'å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è‡ªå‹•ä¿®æ­£'
    cmd: pnpm run fix

  typecheck:
    desc: 'å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å‹ãƒã‚§ãƒƒã‚¯'
    cmd: pnpm run typecheck

  build:
    desc: 'å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰'
    cmd: pnpm run build

  build:web:
    desc: 'webãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰'
    cmd: pnpm run build:web

  build:api:
    desc: 'apiãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰'
    cmd: pnpm run build:api

  dev:
    desc: 'é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•(ã™ã¹ã¦)'
    cmds:
      - task: up

  dev:web:
    desc: 'webã®é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•'
    cmd: pnpm run dev:web

  db:shell:
    desc: 'PostgreSQLã‚·ã‚§ãƒ«ã«æ¥ç¶š'
    cmd: task api:db:shell

  db:reset:
    desc: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ'
    cmd: task api:db:reset

  # ========================================
  # Preview (production build) Tasks
  # Service Worker / PWA å‹•ä½œç¢ºèªç”¨
  # ========================================
  preview:up:
    desc: 'PWA/SW ãƒ†ã‚¹ãƒˆç”¨ã® production preview ã‚’èµ·å‹• (localhost:3001)'
    cmds:
      - |
        docker run -d --rm \
          --name web-preview \
          --network tut-bus_default \
          --env-file ./apps/web/.env \
          -e NODE_ENV=production \
          -v {{.ROOT_DIR}}/apps/web:/works \
          -p 3001:3000 \
          --entrypoint sh \
          $(docker build -q ./apps/web -f ./apps/web/dev.Dockerfile) \
          -c "corepack enable && corepack prepare pnpm@10.11.0 --activate && pnpm i && pnpm build && pnpm start"
      - echo "âœ… preview èµ·å‹•ä¸­... ãƒ“ãƒ«ãƒ‰å®Œäº†ã¾ã§ 1-2 åˆ†ã‹ã‹ã‚Šã¾ã™"
      - echo "ğŸ“¡ http://localhost:3001"

  preview:down:
    desc: 'preview ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ãƒ»å‰Šé™¤'
    cmds:
      - docker rm -f web-preview 2>/dev/null || true
      - echo "âœ… preview åœæ­¢"

  preview:logs:
    desc: 'preview ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ­ã‚°ã‚’è¡¨ç¤º'
    cmd: docker logs -f web-preview

  preview:rebuild:
    desc: 'preview ã‚’å†ãƒ“ãƒ«ãƒ‰ã—ã¦èµ·å‹•'
    cmds:
      - task: preview:down
      - task: preview:up

  default:
    desc: 'åˆ©ç”¨å¯èƒ½ãªã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’è¡¨ç¤º'
    cmds:
      - task --list
    silent: true

  # ========================================
  # Terraform Tasks
  # ========================================
  tf:init:
    desc: 'Terraformã‚’åˆæœŸåŒ–'
    dir: infra
    cmd: terraform init

  tf:plan:
    desc: 'Terraformãƒ—ãƒ©ãƒ³ã‚’è¡¨ç¤º'
    dir: infra
    cmd: terraform plan -var-file=production.tfvars

  tf:apply:
    desc: 'Terraformã‚’é©ç”¨'
    dir: infra
    cmd: terraform apply -var-file=production.tfvars

  tf:validate:
    desc: 'Terraformè¨­å®šã‚’æ¤œè¨¼'
    dir: infra
    cmd: terraform validate

  tf:fmt:
    desc: 'Terraformè¨­å®šã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ'
    dir: infra
    cmd: terraform fmt -recursive

  tf:output:
    desc: 'Terraformå‡ºåŠ›ã‚’è¡¨ç¤º'
    dir: infra
    cmd: terraform output
